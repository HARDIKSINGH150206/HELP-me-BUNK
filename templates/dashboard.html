<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HELP-me-BUNK</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-base: #000000;
            --bg-layer-1: #080808;
            --bg-layer-2: #0f0f0f;
            --bg-layer-3: #161616;
            --bg-glass: rgba(8, 8, 8, 0.9);
            --text-primary: #e8e8e8;
            --text-secondary: rgba(232, 232, 232, 0.6);
            --text-muted: rgba(232, 232, 232, 0.35);
            --accent: #6366f1;
            --accent-light: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.15);
            --accent-subtle: rgba(99, 102, 241, 0.06);
            --success: #34d399;
            --success-bg: rgba(52, 211, 153, 0.08);
            --warning: #fbbf24;
            --warning-bg: rgba(251, 191, 36, 0.08);
            --danger: #f87171;
            --danger-bg: rgba(248, 113, 113, 0.08);
            --border: rgba(255, 255, 255, 0.04);
            --border-hover: rgba(99, 102, 241, 0.25);
            --shadow: 0 2px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            --radius: 10px;
            --radius-sm: 6px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-base);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Subtle gradient background */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse 80% 60% at 50% -10%, rgba(99, 102, 241, 0.04), transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-layer-3);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* Top Navigation */
        .navbar {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .nav-logo {
            width: 36px;
            height: 36px;
            background: var(--accent);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--bg-base);
        }

        .nav-title {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .nav-title span {
            color: var(--accent);
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-time {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-layer-2);
            border-radius: var(--radius-sm);
            font-size: 12px;
            color: var(--text-muted);
        }

        .nav-time i {
            color: var(--accent);
            font-size: 10px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
            outline: none;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg-base);
        }

        .btn-primary:hover {
            background: var(--accent-light);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-ghost:hover {
            background: var(--bg-layer-2);
            border-color: var(--border-hover);
            color: var(--text-primary);
        }
        
        .btn-secondary {
            background: var(--bg-layer-2);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-layer-3);
            color: var(--text-primary);
        }
        
        .btn-danger {
            background: transparent;
            color: var(--danger);
            border: 1px solid rgba(255, 82, 82, 0.3);
        }

        .btn-danger:hover {
            background: var(--danger-bg);
        }

        /* Main Layout */
        .main-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
            position: relative;
            z-index: 1;
        }

        /* Hero Section */
        .hero {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            margin-bottom: 28px;
        }

        .hero-main {
            background: var(--bg-layer-1);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 28px;
            display: flex;
            align-items: center;
            gap: 36px;
            position: relative;
            overflow: hidden;
        }

        .hero-main::before {
            content: '';
            position: absolute;
            top: -100%;
            right: -30%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, var(--accent-glow), transparent 70%);
            pointer-events: none;
        }

        .circular-chart {
            position: relative;
            width: 160px;
            height: 160px;
            flex-shrink: 0;
        }

        .circular-chart svg {
            transform: rotate(-90deg);
            width: 160px;
            height: 160px;
        }

        .circular-chart circle {
            fill: none;
            stroke-linecap: round;
        }

        .circular-chart .bg {
            stroke: var(--bg-layer-3);
            stroke-width: 10;
        }

        .circular-chart .progress {
            stroke: var(--accent);
            stroke-width: 10;
            transition: stroke-dashoffset 0.8s ease;
        }

        .circular-chart-center {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .circular-value {
            font-size: 36px;
            font-weight: 700;
            line-height: 1;
            color: var(--text-primary);
        }

        .circular-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .circular-detail {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 6px;
            font-weight: 500;
        }

        .hero-stats {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .hero-stat {
            text-align: center;
            padding: 16px;
            background: var(--bg-layer-2);
            border-radius: var(--radius-sm);
            transition: all 0.15s ease;
        }

        .hero-stat:hover {
            background: var(--bg-layer-3);
        }

        .hero-stat-value {
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 4px;
        }

        .hero-stat-value.success {
            color: var(--success);
        }

        .hero-stat-value.danger {
            color: var(--danger);
        }

        .hero-stat-value.accent {
            color: var(--accent-light);
        }

        .hero-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        /* Quick Actions Card */
        .quick-card {
            background: var(--bg-layer-1);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .quick-card-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
        }

        .quick-card-title i {
            color: var(--accent);
        }

        .quick-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quick-stat {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            background: var(--bg-layer-2);
            border-radius: var(--radius-sm);
            transition: all 0.15s ease;
        }

        .quick-stat:hover {
            background: var(--bg-layer-3);
        }

        .quick-stat-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quick-stat-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .quick-stat-dot.success {
            background: var(--success);
        }

        .quick-stat-dot.warning {
            background: var(--warning);
        }

        .quick-stat-dot.danger {
            background: var(--danger);
        }

        .quick-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .quick-stat-value {
            font-size: 16px;
            font-weight: 600;
        }

        /* Section Header */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
        }

        .section-title::before {
            content: '';
            width: 3px;
            height: 16px;
            background: var(--accent);
            border-radius: 2px;
        }

        .tabs {
            display: flex;
            gap: 2px;
            background: var(--bg-layer-1);
            padding: 3px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .tab {
            padding: 6px 14px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .tab:hover {
            color: var(--text-secondary);
        }

        .tab.active {
            background: var(--bg-layer-3);
            color: var(--text-primary);
        }

        /* Subject Cards Grid */
        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 16px;
        }

        .subject-card {
            background: var(--bg-layer-1);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: all 0.15s ease;
            position: relative;
            overflow: hidden;
        }

        .subject-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
        }

        .subject-card.safe::before {
            background: var(--success);
        }

        .subject-card.warning::before {
            background: var(--warning);
        }

        .subject-card.danger::before {
            background: var(--danger);
        }

        .subject-card:hover {
            border-color: var(--border-hover);
            background: var(--bg-layer-2);
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .subject-info {
            flex: 1;
            padding-right: 12px;
        }

        .subject-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .subject-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .subject-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .subject-percentage {
            text-align: right;
        }

        .percentage-value {
            font-size: 24px;
            font-weight: 700;
            line-height: 1;
        }

        .percentage-value.safe {
            color: var(--success);
        }

        .percentage-value.warning {
            color: var(--warning);
        }

        .percentage-value.danger {
            color: var(--danger);
        }

        .percentage-change {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .subject-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .stat-box {
            text-align: center;
            padding: 10px;
            background: var(--bg-layer-2);
            border-radius: 6px;
        }

        .stat-box-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-box-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .progress-track {
            height: 8px;
            background: var(--bg-layer-3);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 16px;
            position: relative;
        }

        .progress-track::after {
            content: '';
            position: absolute;
            left: 75%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255, 255, 255, 0.3);
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-fill.safe {
            background: linear-gradient(90deg, var(--success), #00ffcc);
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, var(--warning), #ffd700);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, var(--danger), #ff8888);
        }

        .recommendation {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
        }

        .recommendation.safe {
            background: var(--success-bg);
            color: var(--success);
        }

        .recommendation.warning {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .recommendation.danger {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .recommendation i {
            font-size: 16px;
        }

        .recommendation strong {
            color: var(--text-primary);
            font-weight: 700;
        }

        .projected-info {
            margin-top: 12px;
            padding: 10px 14px;
            background: rgba(148, 137, 121, 0.1);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 13px;
            color: var(--text-secondary);
            text-align: center;
        }

        .projected-info strong {
            color: var(--accent-light);
            font-weight: 600;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-layer-1);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-header h3 i {
            color: var(--accent);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-subtitle {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 14px;
        }

        .modal-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .modal-form .form-group {
            margin: 0;
        }

        .modal-form label {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .modal-form input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-layer-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .modal-form input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            gap: 12px;
        }

        .modal-footer>div {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg-base);
        }

        .btn-primary:hover {
            background: var(--accent-light);
        }

        .btn-secondary {
            background: var(--bg-layer-2);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-layer-3);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        /* Empty & Loading States */
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            background: var(--bg-layer-3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .empty-icon i {
            font-size: 32px;
            color: var(--text-muted);
        }

        .empty-state h2 {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .empty-state p {
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .loading {
            text-align: center;
            padding: 80px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--bg-layer-3);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .hero {
                grid-template-columns: 1fr;
            }

            .quick-card {
                order: -1;
            }

            .quick-stats {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .quick-stat {
                flex: 1;
                min-width: 150px;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 0 16px;
            }

            .main-wrapper {
                padding: 16px;
            }

            .hero-main {
                flex-direction: column;
                gap: 24px;
            }

            .hero-stats {
                width: 100%;
            }

            .subjects-grid {
                grid-template-columns: 1fr;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .nav-title {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .hero-stats {
                grid-template-columns: 1fr;
            }

            .subject-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Calendar Styles */
        .calendar-container {
            display: none;
            margin-top: 20px;
        }

        .calendar-container.active {
            display: block;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .calendar-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .calendar-legend {
            display: flex;
            gap: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .legend-dot.bunkable {
            background: var(--success);
        }

        .legend-dot.risky {
            background: var(--danger);
        }

        .calendar-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .calendar-actions .btn-secondary {
            background: var(--bg-layer-2);
            border: 1px solid var(--border);
        }

        .calendar-actions .btn-secondary:hover {
            background: var(--bg-layer-3);
        }

        .weekly-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .day-column {
            background: var(--bg-layer-1);
            border-radius: var(--radius);
            padding: 14px;
            border: 1px solid var(--border);
            min-height: 180px;
        }

        .day-header {
            font-weight: 500;
            font-size: 12px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .class-slot {
            background: var(--bg-layer-2);
            border-radius: 6px;
            padding: 8px 10px;
            margin-bottom: 6px;
            border-left: 2px solid var(--border);
            transition: all 0.15s;
            cursor: pointer;
        }

        .class-slot:hover {
            background: var(--bg-layer-3);
        }

        .class-slot.bunkable {
            border-left-color: var(--success);
        }

        .class-slot.risky {
            border-left-color: var(--danger);
        }

        .class-time {
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .class-name {
            font-weight: 500;
            font-size: 12px;
            margin-bottom: 2px;
        }

        .class-status {
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .class-status.bunkable {
            color: var(--success);
        }

        .class-status.risky {
            color: var(--danger);
        }

        .add-class-btn {
            width: 100%;
            padding: 6px;
            background: transparent;
            border: 1px dashed var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
            margin-top: 6px;
            font-size: 11px;
        }

        .add-class-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .view-toggle {
            display: flex;
            gap: 4px;
            margin-left: auto;
            background: var(--bg-layer-1);
            padding: 3px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .view-btn {
            padding: 6px 14px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.15s;
        }

        .view-btn:hover {
            color: var(--text-secondary);
        }

        .view-btn.active {
            background: var(--accent);
            color: var(--bg-base);
        }

        @media (max-width: 1024px) {
            .weekly-calendar {
                grid-template-columns: 1fr;
            }

            .day-column {
                min-height: auto;
            }
        }

        /* Analytics & Charts Styles */
        .analytics-section {
            margin-top: 40px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--accent);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--bg-layer-1);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .chart-card h3 {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        /* Risk Alerts */
        .risk-alerts {
            margin-bottom: 30px;
        }

        .alert-card {
            background: var(--danger-bg);
            border: 1px solid var(--danger);
            border-radius: var(--radius);
            padding: 16px 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .alert-card.warning {
            background: var(--warning-bg);
            border-color: var(--warning);
        }

        .alert-card.critical {
            background: var(--danger-bg);
            border-color: var(--danger);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .alert-icon {
            font-size: 24px;
            color: var(--danger);
        }

        .alert-card.warning .alert-icon {
            color: var(--warning);
        }

        .alert-content {
            flex: 1;
        }

        .alert-subject {
            font-weight: 600;
            font-size: 15px;
        }

        .alert-message {
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 4px;
        }

        .alert-pct {
            font-size: 24px;
            font-weight: 700;
            color: var(--danger);
        }

        .alert-card.warning .alert-pct {
            color: var(--warning);
        }

        /* Predictions Grid */
        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .prediction-card {
            background: var(--bg-layer-1);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .prediction-card.safe {
            border-left: 4px solid var(--success);
        }

        .prediction-card.warning {
            border-left: 4px solid var(--warning);
        }

        .prediction-card.danger,
        .prediction-card.critical {
            border-left: 4px solid var(--danger);
        }

        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .prediction-subject {
            font-weight: 600;
            font-size: 14px;
        }

        .prediction-current {
            font-size: 20px;
            font-weight: 700;
        }

        .prediction-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .prediction-stat {
            background: var(--bg-layer-2);
            padding: 10px;
            border-radius: var(--radius-sm);
        }

        .prediction-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .prediction-stat-value {
            font-size: 16px;
            font-weight: 600;
            margin-top: 4px;
        }

        .prediction-message {
            margin-top: 12px;
            padding: 10px;
            background: var(--bg-layer-2);
            border-radius: var(--radius-sm);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .safe .prediction-current { color: var(--success); }
        .warning .prediction-current { color: var(--warning); }
        .danger .prediction-current,
        .critical .prediction-current { color: var(--danger); }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }

        .tab-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-layer-2);
        }

        .tab-btn.active {
            color: var(--accent);
            background: var(--accent-subtle);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .predictions-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- SVG Gradient Definition -->
    <svg width="0" height="0">
        <defs>
            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#6366f1" />
                <stop offset="100%" style="stop-color:#34d399" />
            </linearGradient>
        </defs>
    </svg>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-brand">
            <div class="nav-logo">
                <i class="fas fa-chart-pie"></i>
            </div>
            <div class="nav-title">HELP-me-<span>BUNK</span></div>
        </div>
        <div class="nav-actions">
            <div class="nav-time">
                <i class="fas fa-clock"></i>
                <span id="lastUpdated">Loading...</span>
            </div>
            <div class="nav-time" id="userDisplay" style="display: none;">
                <i class="fas fa-user"></i>
                <span id="usernameDisplay">User</span>
            </div>
            <button class="btn btn-ghost" onclick="syncWithERP()">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
            <button class="btn btn-ghost" onclick="logout()" title="Logout">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-wrapper">
        <!-- Hero Section -->
        <div class="hero">
            <div class="hero-main">
                <div class="circular-chart">
                    <svg viewBox="0 0 180 180">
                        <circle class="bg" cx="90" cy="90" r="78"></circle>
                        <circle class="progress" cx="90" cy="90" r="78" stroke-dasharray="490" stroke-dashoffset="490"
                            id="mainCircle"></circle>
                    </svg>
                    <div class="circular-chart-center">
                        <div class="circular-value" id="avgValue">--%</div>
                        <div class="circular-label">Overall</div>
                        <div class="circular-detail" id="overallDetail">--/-- classes</div>
                    </div>
                </div>
                <div class="hero-stats">
                    <div class="hero-stat">
                        <div class="hero-stat-value accent" id="totalSubjects">--</div>
                        <div class="hero-stat-label">Total Subjects</div>
                    </div>
                    <div class="hero-stat">
                        <div class="hero-stat-value success" id="safeSubjects">--</div>
                        <div class="hero-stat-label">Safe Zone</div>
                    </div>
                    <div class="hero-stat">
                        <div class="hero-stat-value danger" id="dangerSubjects">--</div>
                        <div class="hero-stat-label">At Risk</div>
                    </div>
                </div>
            </div>
            <div class="quick-card">
                <div class="quick-card-title">
                    <i class="fas fa-chart-bar"></i>
                    Status Breakdown
                </div>
                <div class="quick-stats">
                    <div class="quick-stat">
                        <div class="quick-stat-left">
                            <div class="quick-stat-dot success"></div>
                            <span class="quick-stat-label">Safe (â‰¥76%)</span>
                        </div>
                        <span class="quick-stat-value" id="safeCount">--</span>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-left">
                            <div class="quick-stat-dot warning"></div>
                            <span class="quick-stat-label">Warning (75%)</span>
                        </div>
                        <span class="quick-stat-value" id="warningCount">--</span>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-left">
                            <div class="quick-stat-dot danger"></div>
                            <span class="quick-stat-label">Critical (&lt;75%)</span>
                        </div>
                        <span class="quick-stat-value" id="dangerCount">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Toggle -->
        <div class="section-header">
            <h2 class="section-title">Your Schedule</h2>
            <div class="view-toggle">
                <button class="view-btn active" onclick="showView('attendance', this)">
                    <i class="fas fa-list"></i> Attendance
                </button>
                <button class="view-btn" onclick="showView('calendar', this)">
                    <i class="fas fa-calendar-alt"></i> Calendar
                </button>
            </div>
        </div>

        <!-- Attendance View -->
        <div id="attendanceView" class="attendance-view">
            <div class="section-header">
                <h2 class="section-title">Subject Details</h2>
                <div class="tabs">
                    <button class="tab active" onclick="filterSubjects('all', this)">All</button>
                    <button class="tab" onclick="filterSubjects('safe', this)">Safe</button>
                    <button class="tab" onclick="filterSubjects('warning', this)">Warning</button>
                    <button class="tab" onclick="filterSubjects('danger', this)">At Risk</button>
                </div>
            </div>

            <div id="subjectsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Loading attendance data...</div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div class="analytics-section" id="analyticsSection">
                <!-- Risk Alerts -->
                <div class="risk-alerts" id="riskAlerts" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Risk Alerts
                        </h2>
                    </div>
                    <div id="alertsContainer"></div>
                </div>

                <!-- Tab Navigation for Analytics -->
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Analytics & Predictions
                    </h2>
                </div>

                <div class="tab-nav">
                    <button class="tab-btn active" onclick="switchAnalyticsTab('predictions', this)">
                        <i class="fas fa-crystal-ball"></i> Predictions
                    </button>
                    <button class="tab-btn" onclick="switchAnalyticsTab('trends', this)">
                        <i class="fas fa-chart-area"></i> Trends
                    </button>
                    <button class="tab-btn" onclick="switchAnalyticsTab('comparison', this)">
                        <i class="fas fa-chart-bar"></i> Subject Comparison
                    </button>
                </div>

                <!-- Predictions Tab -->
                <div class="tab-content active" id="predictionsTab">
                    <div class="predictions-grid" id="predictionsGrid">
                        <div class="loading">
                            <div class="spinner"></div>
                            <div class="loading-text">Loading predictions...</div>
                        </div>
                    </div>
                </div>

                <!-- Trends Tab -->
                <div class="tab-content" id="trendsTab">
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-line"></i> Overall Attendance Trend</h3>
                            <div class="chart-container">
                                <canvas id="overallTrendChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3><i class="fas fa-calendar-week"></i> Weekly Average</h3>
                            <div class="chart-container">
                                <canvas id="weeklyTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comparison Tab -->
                <div class="tab-content" id="comparisonTab">
                    <div class="charts-grid">
                        <div class="chart-card" style="grid-column: 1 / -1;">
                            <h3><i class="fas fa-chart-bar"></i> Subject-wise Comparison</h3>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="subjectComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="calendarView" class="calendar-container">
            <div class="calendar-header">
                <div class="calendar-legend">
                    <div class="legend-item">
                        <div class="legend-dot bunkable"></div>
                        <span>Can Bunk</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot risky"></div>
                        <span>Don't Skip</span>
                    </div>
                </div>
                <div class="calendar-actions">
                    <input type="file" id="timetableUpload" accept="image/*" style="display: none;"
                        onchange="handleTimetableUpload(event)">
                    <button class="btn btn-secondary" onclick="showPasteModal()">
                        <i class="fas fa-paste"></i> Paste Text
                    </button>
                    <button class="btn btn-primary" onclick="showAddClassModal()">
                        <i class="fas fa-plus"></i> Add Class
                    </button>
                    <button class="btn btn-danger" onclick="clearTimetable()" style="margin-left: 10px;">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>
            </div>

            <div class="weekly-calendar" id="weeklyCalendar">
                <!-- Days will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        let allSubjects = [];

        function getStatusClass(pct) {
            // safe >= 85%, warning 75-85%, danger < 75%
            if (pct >= 85) return 'safe';
            if (pct >= 75) return 'warning';
            return 'danger';
        }

        function filterSubjects(filter, btn) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');

            const filtered = allSubjects.filter(s => {
                if (filter === 'all') return true;
                return getStatusClass(s.percentage) === filter;
            });

            renderSubjects(filtered);
        }

        function renderSubjects(subjects) {
            const container = document.getElementById('subjectsContainer');

            if (subjects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"><i class="fas fa-filter"></i></div>
                        <h2>No Subjects Found</h2>
                        <p>No subjects match the current filter</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="subjects-grid">';

            subjects.forEach(subject => {
                const pct = subject.percentage;
                const status = getStatusClass(pct);
                const present = subject.present;
                const total = subject.total;
                const absent = total - present;

                // Use smart calculations from API if available
                const hasSmartData = subject.remaining_classes !== undefined && subject.remaining_classes > 0;
                const remainingClasses = subject.remaining_classes || 0;
                const classesNeeded = subject.classes_needed_75 || 0;
                const canSkip = subject.can_skip || 0;
                const projectedPct = subject.projected_percentage || pct;

                let recText = '', recIcon = '', extraInfo = '';

                if (hasSmartData) {
                    // Smart recommendations based on timetable
                    // safe >= 85%, warning 75-85%, danger < 75%
                    if (pct >= 85 && canSkip > 0) {
                        recText = `Safe zone! Can skip <strong>${canSkip}</strong> of ${remainingClasses} remaining classes`;
                        recIcon = 'fa-thumbs-up';
                    } else if (pct >= 75 && canSkip > 0) {
                        recText = `Warning zone. Can skip <strong>${canSkip}</strong> classes, aim for 85%`;
                        recIcon = 'fa-exclamation-circle';
                    } else if (classesNeeded <= 0 && pct >= 75) {
                        recText = `Above 75%! ${remainingClasses} remaining classes`;
                        recIcon = 'fa-check-circle';
                    } else if (classesNeeded > 0) {
                        recText = `Must attend <strong>${classesNeeded}</strong> of ${remainingClasses} remaining classes`;
                        recIcon = classesNeeded >= remainingClasses ? 'fa-triangle-exclamation' : 'fa-exclamation-circle';
                    } else {
                        recText = `${remainingClasses} classes remaining this semester`;
                        recIcon = 'fa-calendar';
                    }

                    // Extra info for projected percentage
                    if (projectedPct !== pct) {
                        extraInfo = `<div class="projected-info">Projected if attending all: <strong>${projectedPct.toFixed(1)}%</strong></div>`;
                    }
                } else {
                    // Fallback to old calculation without timetable
                    // safe >= 85%, warning 75-85%, danger < 75%
                    if (pct >= 85) {
                        const skipCalc = Math.floor((present - 0.75 * total) / 0.75);
                        recText = `Safe zone! Can skip <strong>${Math.max(0, skipCalc)}</strong> classes`;
                        recIcon = 'fa-thumbs-up';
                    } else if (pct >= 75) {
                        const need = Math.ceil((85 * total - 100 * present) / 15);
                        recText = `Attend <strong>${need}</strong> more to reach safe zone (85%)`;
                        recIcon = 'fa-exclamation-circle';
                    } else {
                        const need = Math.ceil((75 * total - 100 * present) / 25);
                        recText = `Must attend <strong>${need}</strong> classes urgently`;
                        recIcon = 'fa-triangle-exclamation';
                    }
                }

                html += `
                    <div class="subject-card ${status}">
                        <div class="subject-header">
                            <div class="subject-info">
                                <div class="subject-name">${subject.subject}</div>
                                <div class="subject-meta">
                                    <span><i class="fas fa-clock"></i> ${total} classes${hasSmartData ? ` â€¢ ${remainingClasses} remaining` : ''}</span>
                                </div>
                            </div>
                            <div class="subject-percentage">
                                <div class="percentage-value ${status}">${pct.toFixed(1)}%</div>
                                <div class="percentage-change">attendance</div>
                            </div>
                        </div>
                        
                        <div class="subject-stats">
                            <div class="stat-box">
                                <div class="stat-box-value">${present}</div>
                                <div class="stat-box-label">Present</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-box-value">${absent}</div>
                                <div class="stat-box-label">Absent</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-box-value">${total}</div>
                                <div class="stat-box-label">Total</div>
                            </div>
                            ${hasSmartData ? `
                            <div class="stat-box">
                                <div class="stat-box-value">${classesNeeded}</div>
                                <div class="stat-box-label">Need for 75%</div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="progress-track">
                            <div class="progress-fill ${status}" style="width: ${Math.min(pct, 100)}%"></div>
                        </div>
                        
                        <div class="recommendation ${status}">
                            <i class="fas ${recIcon}"></i>
                            <span>${recText}</span>
                        </div>
                        ${extraInfo}
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        async function loadData() {
            try {
                console.log('Loading data...');
                const response = await fetch('/api/latest-data', {
                    credentials: 'include'
                });
                console.log('Response status:', response.status);

                // Check for auth errors - redirect to login
                if (response.status === 401 || response.status === 302) {
                    window.location.href = '/';
                    return;
                }

                const data = await response.json();
                console.log('Data received:', data);

                if (data.error) {
                    document.getElementById('subjectsContainer').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"><i class="fas fa-spinner fa-spin"></i></div>
                            <h2>Loading Data...</h2>
                            <p>Data is being scraped from ERP. This page will auto-refresh.</p>
                            <button class="btn btn-primary" onclick="showAddSubjectForm()">
                                <i class="fas fa-plus"></i> Add Subject Manually
                            </button>
                        </div>
                    `;
                    // Update stats to show zeros
                    document.getElementById('totalSubjects').textContent = '0';
                    document.getElementById('safeSubjects').textContent = '0';
                    document.getElementById('dangerSubjects').textContent = '0';
                    document.getElementById('safeCount').textContent = '0';
                    document.getElementById('warningCount').textContent = '0';
                    document.getElementById('dangerCount').textContent = '0';
                    document.getElementById('avgValue').textContent = '0%';
                    document.getElementById('overallDetail').textContent = '0/0 classes';
                    document.getElementById('lastUpdated').textContent = 'Waiting for data...';

                    // Auto-poll for data every 3 seconds when no data available
                    setTimeout(loadData, 3000);
                    return;
                }

                // Stats
                const total = data.stats.total;
                const safe = data.stats.safe;
                const warning = data.stats.warning || 0;
                const danger = data.stats.danger;
                
                // Use ERP overall attendance (directly from ERP)
                const erpOverall = data.erp_overall || {};
                const avg = erpOverall.percentage !== undefined ? erpOverall.percentage : data.stats.average;
                const totalPresent = erpOverall.present !== undefined ? erpOverall.present : (data.stats.total_present || 0);
                const totalClasses = erpOverall.total !== undefined ? erpOverall.total : (data.stats.total_classes || 0);

                document.getElementById('totalSubjects').textContent = total;
                document.getElementById('safeSubjects').textContent = safe;
                document.getElementById('dangerSubjects').textContent = danger;
                document.getElementById('safeCount').textContent = safe;
                document.getElementById('warningCount').textContent = warning;
                document.getElementById('dangerCount').textContent = danger;
                document.getElementById('avgValue').textContent = avg.toFixed(1) + '%';
                document.getElementById('overallDetail').textContent = `${totalPresent}/${totalClasses} classes`;

                // Circular progress
                const circumference = 2 * Math.PI * 78;
                const offset = circumference - (avg / 100) * circumference;
                document.getElementById('mainCircle').style.strokeDashoffset = offset;

                // Last updated
                document.getElementById('lastUpdated').textContent = data.timestamp || new Date().toLocaleString();

                // Render
                allSubjects = data.subjects;
                renderSubjects(allSubjects);

            } catch (error) {
                document.getElementById('subjectsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <h2>Error Loading Data</h2>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadData()">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Add subject manually
        async function showAddSubjectForm() {
            const subjectName = prompt('Enter subject name:');
            if (!subjectName) return;

            const present = parseInt(prompt('Enter present classes:', '0') || '0');
            const total = parseInt(prompt('Enter total classes:', '1') || '1');

            if (total <= 0) {
                alert('Total classes must be greater than 0');
                return;
            }

            try {
                const response = await fetch('/api/add-subject', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subject: subjectName, present, total })
                });
                const data = await response.json();

                if (data.success) {
                    loadData();
                } else {
                    alert(data.error || 'Failed to add subject');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Logout function
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    const response = await fetch('/api/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    window.location.href = '/';
                } catch (error) {
                    window.location.href = '/logout';
                }
            }
        }

        // View Toggle Function
        function showView(view, btn) {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (view === 'calendar') {
                document.getElementById('attendanceView').style.display = 'none';
                document.getElementById('calendarView').classList.add('active');
                loadTimetable();
            } else {
                document.getElementById('attendanceView').style.display = 'block';
                document.getElementById('calendarView').classList.remove('active');
            }
        }

        // Timetable/Calendar Functions
        let timetableData = [];
        const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        async function loadTimetable() {
            try {
                const response = await fetch('/api/timetable', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    renderEmptyCalendar();
                    return;
                }

                const data = await response.json();
                timetableData = data.timetable || [];
                renderCalendar(timetableData);

            } catch (error) {
                console.log('Could not load timetable:', error);
                renderEmptyCalendar();
            }
        }

        function renderEmptyCalendar() {
            const container = document.getElementById('weeklyCalendar');
            let html = '';

            dayNames.forEach((day, idx) => {
                html += `
                    <div class="day-column">
                        <div class="day-header">${day}</div>
                        <div class="empty-day">
                            <p style="color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 20px 0;">
                                No classes
                            </p>
                        </div>
                        <button class="add-class-btn" onclick="showAddClassModal(${idx})">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderCalendar(timetable) {
            const container = document.getElementById('weeklyCalendar');

            // Group classes by day
            const byDay = {};
            dayNames.forEach((_, idx) => byDay[idx] = []);

            timetable.forEach(entry => {
                if (entry.day !== null && entry.day !== undefined) {
                    byDay[entry.day].push(entry);
                }
            });

            let html = '';

            dayNames.forEach((dayName, idx) => {
                const classes = byDay[idx] || [];

                // Sort by start time
                classes.sort((a, b) => {
                    if (!a.start_time) return 1;
                    if (!b.start_time) return -1;
                    return a.start_time.localeCompare(b.start_time);
                });

                html += `
                    <div class="day-column">
                        <div class="day-header">${dayName}</div>
                `;

                if (classes.length === 0) {
                    html += `
                        <div class="empty-day">
                            <p style="color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 20px 0;">
                                No classes
                            </p>
                        </div>
                    `;
                } else {
                    classes.forEach(cls => {
                        const statusClass = cls.can_bunk ? 'bunkable' : 'risky';
                        const statusIcon = cls.can_bunk ? 'fa-check-circle' : 'fa-exclamation-circle';
                        const statusText = cls.can_bunk
                            ? `Can skip (${cls.classes_to_spare} left)`
                            : `Don't skip (${cls.current_pct.toFixed(1)}%)`;

                        html += `
                            <div class="class-slot ${statusClass}" onclick="deleteClassPrompt('${cls.subject.replace(/'/g, "\\'")}', ${idx}, '${cls.start_time}')">
                                <div class="class-time">
                                    ${cls.start_time || '?'} - ${cls.end_time || '?'}
                                </div>
                                <div class="class-name">${cls.subject}</div>
                                <div class="class-status ${statusClass}">
                                    <i class="fas ${statusIcon}"></i>
                                    ${statusText}
                                </div>
                            </div>
                        `;
                    });
                }

                html += `
                        <button class="add-class-btn" onclick="showAddClassModal(${idx})">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function showAddClassModal(dayIndex = 0) {
            const subject = prompt('Enter subject name:');
            if (!subject) return;

            const startTime = prompt('Enter start time (e.g., 09:00):', '09:00');
            if (!startTime) return;

            const endTime = prompt('Enter end time (e.g., 10:00):', '10:00');
            if (!endTime) return;

            const day = dayIndex !== undefined ? dayIndex : parseInt(prompt('Enter day (0=Mon, 1=Tue, ..., 6=Sun):', '0') || '0');

            addTimetableEntry(subject, day, startTime, endTime);
        }

        async function addTimetableEntry(subject, day, startTime, endTime) {
            try {
                const response = await fetch('/api/timetable/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        subject: subject,
                        day: day,
                        start_time: startTime,
                        end_time: endTime
                    })
                });

                const data = await response.json();
                if (data.success) {
                    loadTimetable();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error adding class: ' + error.message);
            }
        }

        function deleteClassPrompt(subject, day, startTime) {
            if (confirm(`Delete "${subject}" at ${startTime}?`)) {
                deleteTimetableEntry(subject, day, startTime);
            }
        }

        // Show paste timetable modal
        function showPasteModal() {
            const modalHtml = `
                <div id="pasteModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: var(--bg-layer-1); border-radius: 16px; padding: 24px; width: 90%; max-width: 600px; border: 1px solid var(--border);">
                        <h3 style="margin-bottom: 16px; color: var(--text-primary);">
                            <i class="fas fa-paste" style="color: var(--accent);"></i> Paste Your Timetable
                        </h3>
                        <p style="color: var(--text-secondary); margin-bottom: 12px; font-size: 14px;">
                            Enter your timetable in this format (one day per line):
                        </p>
                        <div style="background: var(--bg-layer-2); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-family: monospace; font-size: 13px; color: var(--text-muted);">
                            Monday: Math 9:00-10:00, Physics 10:00-11:00<br>
                            Tuesday: Chemistry 9-10, English 11-12<br>
                            Wed: Biology 9am-10am, History 2pm-3pm
                        </div>
                        <textarea id="pasteTextarea" placeholder="Paste your timetable here..." 
                            style="width: 100%; height: 200px; background: var(--bg-layer-2); border: 1px solid var(--border); border-radius: 8px; padding: 12px; color: var(--text-primary); font-family: inherit; font-size: 14px; resize: vertical;"></textarea>
                        <div style="display: flex; gap: 12px; margin-top: 16px; justify-content: flex-end;">
                            <button onclick="closePasteModal()" class="btn btn-ghost">Cancel</button>
                            <button onclick="submitPastedTimetable()" class="btn btn-primary">
                                <i class="fas fa-check"></i> Add Classes
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closePasteModal() {
            const modal = document.getElementById('pasteModal');
            if (modal) modal.remove();
        }

        async function submitPastedTimetable() {
            const textarea = document.getElementById('pasteTextarea');
            const text = textarea.value.trim();
            
            if (!text) {
                alert('Please paste your timetable text');
                return;
            }

            try {
                const response = await fetch('/api/timetable/paste', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ text: text })
                });

                const data = await response.json();
                
                if (data.success) {
                    closePasteModal();
                    if (data.entries_saved > 0) {
                        alert(`Added ${data.entries_saved} classes to your timetable!`);
                        loadTimetable();
                    } else if (data.entries_found > 0) {
                        alert(`Found ${data.entries_found} classes but they may already exist.`);
                        loadTimetable();
                    } else {
                        alert('No classes found. Make sure to use the format:\nMonday: Subject 9:00-10:00');
                    }
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteTimetableEntry(subject, day, startTime) {
            try {
                const response = await fetch('/api/timetable/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        subject: subject,
                        day: day,
                        start_time: startTime
                    })
                });

                const data = await response.json();
                if (data.success) {
                    loadTimetable();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting class: ' + error.message);
            }
        }

        // Handle timetable image upload
        async function handleTimetableUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Show loading state
            const btn = document.querySelector('.calendar-actions .btn-secondary');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;

            try {
                // Convert to base64
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                // Send to OCR endpoint
                const response = await fetch('/api/timetable/ocr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ image: base64 })
                });

                const data = await response.json();

                if (data.success) {
                    if (data.entries_found > 0) {
                        alert(`Found ${data.entries_found} classes from image!\n\nExtracted text:\n${data.extracted_text.substring(0, 300)}...`);
                        loadTimetable();
                    } else {
                        alert('No classes found in image.\n\nExtracted text:\n' + data.extracted_text.substring(0, 500));
                    }
                } else {
                    alert('OCR Error: ' + data.error);
                }
            } catch (error) {
                alert('Upload error: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                event.target.value = '';  // Reset file input
            }
        }

        // Clear all timetable entries
        async function clearTimetable() {
            if (!confirm('Are you sure you want to delete ALL classes from your timetable?')) {
                return;
            }

            try {
                const response = await fetch('/api/timetable/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.success) {
                    loadTimetable();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error clearing timetable: ' + error.message);
            }
        }

        // Load config and display username
        async function loadConfig() {
            try {
                const response = await fetch('/api/config', {
                    credentials: 'include'
                });
                if (!response.ok) return;
                const data = await response.json();
                if (data.username) {
                    document.getElementById('usernameDisplay').textContent = data.username;
                    document.getElementById('userDisplay').style.display = 'flex';
                }
            } catch (error) {
                console.log('Could not load config:', error);
            }
        }

        // Sync with ERP
        let isSyncing = false;
        
        async function syncWithERP() {
            if (isSyncing) return;
            
            try {
                isSyncing = true;
                updateSyncButton(true);
                
                const response = await fetch('/api/auto-sync', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.needs_credentials) {
                    // Need to prompt for credentials - load local data first
                    isSyncing = false;
                    updateSyncButton(false);
                    await loadData();  // Show cached data
                    showCredentialsModal();
                    return;
                }
                
                if (data.success) {
                    // Poll for scrape status
                    pollScrapeStatus();
                } else {
                    isSyncing = false;
                    updateSyncButton(false);
                    await loadData();  // Show cached data on error
                    console.log('Sync error:', data.error);
                }
            } catch (error) {
                isSyncing = false;
                updateSyncButton(false);
                console.error('Sync error:', error);
                // Fallback - just load local data
                loadData();
            }
        }
        
        function updateSyncButton(syncing) {
            const btn = document.querySelector('.btn-ghost[onclick*="sync"]');
            if (btn) {
                if (syncing) {
                    btn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Syncing...';
                    btn.disabled = true;
                } else {
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                    btn.disabled = false;
                }
            }
        }
        
        async function pollScrapeStatus() {
            try {
                const response = await fetch('/api/scrape-status', {
                    credentials: 'include'
                });
                const status = await response.json();
                
                if (status.running) {
                    // Still running, poll again
                    setTimeout(pollScrapeStatus, 2000);
                } else {
                    isSyncing = false;
                    updateSyncButton(false);
                    
                    if (status.error) {
                        // Check if it's a login failure
                        if (status.error.toLowerCase().includes('login failed') || 
                            status.error.toLowerCase().includes('invalid credentials') ||
                            status.error.toLowerCase().includes('authentication')) {
                            showCredentialsModal(true); // Show with error message
                        } else {
                            alert('Sync error: ' + status.error);
                        }
                    } else if (status.complete) {
                        // Refresh data and predictions
                        loadData();
                        loadPredictions();
                        loadTrendsData();
                    }
                }
            } catch (error) {
                isSyncing = false;
                updateSyncButton(false);
                loadData();
            }
        }
        
        function showCredentialsModal(isLoginFailed = false) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'credentialsModal';
            
            const errorBanner = isLoginFailed ? `
                <div style="background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-exclamation-circle" style="color: #ef4444;"></i>
                    <span style="color: #fca5a5;">ERP login failed. Please check your credentials and try again.</span>
                </div>
            ` : '';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h2 class="modal-title"><i class="fas fa-key"></i> ${isLoginFailed ? 'Update ERP Credentials' : 'ERP Credentials Required'}</h2>
                        <button class="btn btn-ghost" onclick="closeCredentialsModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${errorBanner}
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Enter your ERP credentials to sync attendance data.</p>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">ERP Username</label>
                            <input type="text" id="erpUsername" class="form-control" placeholder="Enter ERP username" style="width: 100%; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary);">
                        </div>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">ERP Password</label>
                            <input type="password" id="erpPassword" class="form-control" placeholder="Enter ERP password" style="width: 100%; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary);">
                        </div>
                        <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); cursor: pointer;">
                            <input type="checkbox" id="saveCredentials" checked>
                            Save credentials for auto-sync
                        </label>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-ghost" onclick="closeCredentialsModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="submitCredentials()">
                            <i class="fas fa-sync-alt"></i> Sync Now
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeCredentialsModal() {
            const modal = document.getElementById('credentialsModal');
            if (modal) modal.remove();
        }
        
        async function submitCredentials() {
            const username = document.getElementById('erpUsername').value.trim();
            const password = document.getElementById('erpPassword').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            closeCredentialsModal();
            isSyncing = true;
            updateSyncButton(true);
            
            try {
                const response = await fetch('/api/scrape', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    pollScrapeStatus();
                } else {
                    isSyncing = false;
                    updateSyncButton(false);
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                isSyncing = false;
                updateSyncButton(false);
                alert('Error starting sync: ' + error.message);
            }
        }

        // ============== ANALYTICS & PREDICTIONS ==============
        
        let overallTrendChart = null;
        let weeklyTrendChart = null;
        let subjectComparisonChart = null;

        function switchAnalyticsTab(tabName, btn) {
            // Update active tab button
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Show selected tab content
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Load data based on tab
            if (tabName === 'predictions') {
                loadPredictions();
            } else if (tabName === 'trends' || tabName === 'comparison') {
                loadTrendsData();
            }
        }

        async function loadPredictions() {
            const container = document.getElementById('predictionsGrid');
            
            try {
                const response = await fetch('/api/predictions', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.log('No predictions available yet');
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-chart-line" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                            <p>No prediction data available yet.</p>
                            <p style="font-size: 12px;">Sync with ERP to see predictions.</p>
                        </div>
                    `;
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    renderRiskAlerts(data.risk_alerts || []);
                    renderPredictions(data.predictions || []);
                } else {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-chart-line" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                            <p>No prediction data available.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading predictions:', error);
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-chart-line" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                        <p>Could not load predictions.</p>
                    </div>
                `;
            }
        }

        function renderRiskAlerts(alerts) {
            const alertsSection = document.getElementById('riskAlerts');
            const container = document.getElementById('alertsContainer');
            
            if (!alerts || alerts.length === 0) {
                alertsSection.style.display = 'none';
                return;
            }
            
            alertsSection.style.display = 'block';
            
            let html = '';
            alerts.forEach(alert => {
                const alertClass = alert.level === 'critical' ? 'critical' : 'danger';
                html += `
                    <div class="alert-card ${alertClass}">
                        <div class="alert-icon">
                            <i class="fas ${alert.level === 'critical' ? 'fa-skull-crossbones' : 'fa-exclamation-triangle'}"></i>
                        </div>
                        <div class="alert-content">
                            <div class="alert-subject">${alert.subject}</div>
                            <div class="alert-message">${alert.message}</div>
                        </div>
                        <div class="alert-pct">${alert.current_pct}%</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderPredictions(predictions) {
            const container = document.getElementById('predictionsGrid');
            
            if (!predictions || predictions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No prediction data available.</p>';
                return;
            }
            
            let html = '';
            predictions.forEach(p => {
                html += `
                    <div class="prediction-card ${p.risk_level}">
                        <div class="prediction-header">
                            <div class="prediction-subject">${p.subject}</div>
                            <div class="prediction-current">${p.current.percentage}%</div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            ${p.current.present}/${p.current.total} classes
                        </div>
                        <div class="prediction-stats">
                            <div class="prediction-stat">
                                <div class="prediction-stat-label">If Attend All</div>
                                <div class="prediction-stat-value" style="color: var(--success);">${p.if_attend_all}%</div>
                            </div>
                            <div class="prediction-stat">
                                <div class="prediction-stat-label">At Current Rate</div>
                                <div class="prediction-stat-value">${p.at_current_rate}%</div>
                            </div>
                            <div class="prediction-stat">
                                <div class="prediction-stat-label">Need for 75%</div>
                                <div class="prediction-stat-value">${p.classes_needed_75} classes</div>
                            </div>
                            <div class="prediction-stat">
                                <div class="prediction-stat-label">Can Skip</div>
                                <div class="prediction-stat-value" style="color: ${p.can_skip > 0 ? 'var(--success)' : 'var(--danger)'};">${p.can_skip} classes</div>
                            </div>
                        </div>
                        <div class="prediction-message">
                            <i class="fas ${p.risk_level === 'safe' ? 'fa-check-circle' : 'fa-exclamation-circle'}" style="color: ${p.risk_level === 'safe' ? 'var(--success)' : 'var(--warning)'};"></i>
                            ${p.risk_message}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function loadTrendsData() {
            try {
                const response = await fetch('/api/trends?days=30', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.log('No trends data available yet');
                    showEmptyChartsMessage();
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    renderOverallTrendChart(data.overall_trend || []);
                    renderWeeklyTrendChart(data.weekly_trend || []);
                    renderSubjectComparisonChart(data.subject_comparison || []);
                } else {
                    showEmptyChartsMessage();
                }
            } catch (error) {
                console.error('Error loading trends:', error);
                showEmptyChartsMessage();
            }
        }

        function showEmptyChartsMessage() {
            const emptyMsg = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                    <i class="fas fa-chart-area" style="font-size: 36px; margin-bottom: 12px; opacity: 0.3;"></i>
                    <p>No trend data yet</p>
                </div>
            `;
            
            const overallCtx = document.getElementById('overallTrendChart');
            const weeklyCtx = document.getElementById('weeklyTrendChart');
            const comparisonCtx = document.getElementById('subjectComparisonChart');
            
            if (overallCtx) overallCtx.parentElement.innerHTML = emptyMsg;
            if (weeklyCtx) weeklyCtx.parentElement.innerHTML = emptyMsg;
            if (comparisonCtx) comparisonCtx.parentElement.innerHTML = emptyMsg;
        }

        function renderOverallTrendChart(trendData) {
            const ctx = document.getElementById('overallTrendChart');
            if (!ctx) return;
            
            if (overallTrendChart) {
                overallTrendChart.destroy();
            }
            
            if (!trendData || trendData.length === 0) {
                ctx.parentElement.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                        <i class="fas fa-chart-line" style="font-size: 36px; margin-bottom: 12px; opacity: 0.3;"></i>
                        <p>No trend data yet</p>
                        <p style="font-size: 11px;">Sync with ERP daily to see trends</p>
                    </div>
                `;
                return;
            }
            
            overallTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.map(d => d.date),
                    datasets: [{
                        label: 'Overall Attendance %',
                        data: trendData.map(d => d.percentage),
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#6366f1'
                    }, {
                        label: 'Target (75%)',
                        data: trendData.map(() => 75),
                        borderColor: '#f87171',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e8e8e8' }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#888' }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        function renderWeeklyTrendChart(weeklyData) {
            const ctx = document.getElementById('weeklyTrendChart');
            if (!ctx) return;
            
            if (weeklyTrendChart) {
                weeklyTrendChart.destroy();
            }
            
            if (!weeklyData || weeklyData.length === 0) {
                ctx.parentElement.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                        <i class="fas fa-chart-bar" style="font-size: 36px; margin-bottom: 12px; opacity: 0.3;"></i>
                        <p>No weekly data yet</p>
                    </div>
                `;
                return;
            }
            
            weeklyTrendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weeklyData.map(d => d.week),
                    datasets: [{
                        label: 'Weekly Average %',
                        data: weeklyData.map(d => d.percentage),
                        backgroundColor: weeklyData.map(d => {
                            if (d.percentage >= 85) return 'rgba(52, 211, 153, 0.7)';
                            if (d.percentage >= 75) return 'rgba(251, 191, 36, 0.7)';
                            return 'rgba(248, 113, 113, 0.7)';
                        }),
                        borderColor: weeklyData.map(d => {
                            if (d.percentage >= 85) return '#34d399';
                            if (d.percentage >= 75) return '#fbbf24';
                            return '#f87171';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e8e8e8' }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#888' }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        function renderSubjectComparisonChart(subjectData) {
            const ctx = document.getElementById('subjectComparisonChart');
            if (!ctx) return;
            
            if (subjectComparisonChart) {
                subjectComparisonChart.destroy();
            }
            
            if (!subjectData || subjectData.length === 0) {
                ctx.parentElement.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                        <i class="fas fa-chart-pie" style="font-size: 36px; margin-bottom: 12px; opacity: 0.3;"></i>
                        <p>No subject data available</p>
                    </div>
                `;
                return;
            }
            
            // Truncate subject names for display
            const labels = subjectData.map(s => s.subject.length > 20 ? s.subject.substring(0, 20) + '...' : s.subject);
            
            subjectComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Attendance %',
                        data: subjectData.map(s => s.percentage),
                        backgroundColor: subjectData.map(s => {
                            if (s.percentage >= 85) return 'rgba(52, 211, 153, 0.8)';
                            if (s.percentage >= 75) return 'rgba(251, 191, 36, 0.8)';
                            return 'rgba(248, 113, 113, 0.8)';
                        }),
                        borderColor: subjectData.map(s => {
                            if (s.percentage >= 85) return '#34d399';
                            if (s.percentage >= 75) return '#fbbf24';
                            return '#f87171';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const idx = context.dataIndex;
                                    const s = subjectData[idx];
                                    return `${s.percentage}% (${s.present}/${s.total})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            min: 0,
                            max: 100,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#888' }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#e8e8e8' }
                        }
                    }
                }
            });
        }

        // Initialize - run when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Dashboard loaded...');
            loadConfig();
            // First load cached data immediately, then try ERP sync
            loadData().then(() => {
                // Load predictions after data is loaded
                loadPredictions();
                // Try to sync with ERP in background (won't block UI)
                syncWithERP();
            });
        });
    </script>
</body>

</html>